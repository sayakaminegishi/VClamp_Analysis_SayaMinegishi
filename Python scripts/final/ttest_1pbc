from scipy import stats
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import glob
import numpy as np
import scipy.optimize
import scipy.signal
import matplotlib.pyplot as plt
import pyabf
import traceback
import logging
from PyQt5.QtWidgets import QApplication, QFileDialog, QInputDialog, QMessageBox
import os
from get_base_filename import get_base_filename
from get_tail_times import getDepolarizationStartEnd, getZoomStartEndTimes
from plotSweepsAndCommand import plotAllSweepsAndCommand
from showInstructions import showInstructions
from concatenate_excelTables import concatenate_excelTables
from statTestsCaCC import conductTtest



######### Ask user input (automatic - no need to change any code here) #########
app = QApplication([])


# Select WKY Control files
showInstructions("Select control files for Strain 1")
options = QFileDialog.Options()

file_paths, _ = QFileDialog.getOpenFileNames(None, "Select control excel files for Strain 1", "", "xlsx Files (*.xlsx);;All Files (*)", options=options)

if not file_paths:
    msg = QMessageBox()
    msg.setIcon(QMessageBox.Warning)
    msg.setText("No file selected. Please select a file.")
    msg.setWindowTitle("Warning")
    msg.exec_()
    exit()

print(f"Selected files: {file_paths}")

df_wkyControl = concatenate_excelTables(file_paths)

# Select WKY treatment files
showInstructions("Select treatment (1PBC) files for Strain 1")
options = QFileDialog.Options()

file_pathsT1, _ = QFileDialog.getOpenFileNames(None, "Select treatment excel files for Strain 1", "", "xlsx Files (*.xlsx);;All Files (*)", options=options)

if not file_pathsT1:
    msg = QMessageBox()
    msg.setIcon(QMessageBox.Warning)
    msg.setText("No file selected. Please select a file.")
    msg.setWindowTitle("Warning")
    msg.exec_()
    exit()

print(f"Selected files: {file_pathsT1}")

df_wky1PBC = concatenate_excelTables(file_pathsT1)


# Select Strain 2 Control files
showInstructions("Select control files for Strain 2")
options = QFileDialog.Options()

file_pathsC2, _ = QFileDialog.getOpenFileNames(None, "Select control excel files for Strain 2", "", "xlsx Files (*.xlsx);;All Files (*)", options=options)

if not file_paths:
    msg = QMessageBox()
    msg.setIcon(QMessageBox.Warning)
    msg.setText("No file selected. Please select a file.")
    msg.setWindowTitle("Warning")
    msg.exec_()
    exit()

print(f"Selected files: {file_pathsC2}")

df_shrControl = concatenate_excelTables(file_pathsC2)


# Select Strain2 treatment files
showInstructions("Select treatment (1PBC) files for Strain 2")
options = QFileDialog.Options()

file_pathsT2, _ = QFileDialog.getOpenFileNames(None, "Select treatment excel files for Strain 2", "", "xlsx Files (*.xlsx);;All Files (*)", options=options)

if not file_pathsT2:
    msg = QMessageBox()
    msg.setIcon(QMessageBox.Warning)
    msg.setText("No file selected. Please select a file.")
    msg.setWindowTitle("Warning")
    msg.exec_()
    exit()

print(f"Selected files: {file_pathsT2}")

df_shr1PBC = concatenate_excelTables(file_pathsT2)

##############################################



t_stat, p_val = conductTtest(df_wkyControl, df_wky1PBC, "Peak_amplitude(pA)")
